<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GENERIA Character Builder</title>

  <style>
    :root{
      font-family: system-ui, sans-serif;

      /* Dark theme tokens */
      --bg: #0f1115;
      --surface: #161a22;
      --surface-2: #1c2230;
      --border: #2a3242;

      --text: #e7eaf0;
      --muted: #aab2c5;
      --danger: #ff6b6b;

      --btn-bg: #1b2130;
      --btn-bg-hover: #232b3d;
      --btn-border: #2a3242;

      --accent: #8aa8ff;
    }

    body{
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px;

      background: var(--bg);
      color: var(--text);
    }

    h1{ font-size: 20px; margin: 0 0 12px; }
    h2{ font-size: 16px; margin: 0 0 10px; }

    .row{
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    .grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 800px){
      .grid{ grid-template-columns: 1fr; }
    }

    .muted{
      color: var(--muted);
      font-size: 13px;
    }

    .pill{
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--surface-2);
    }

    button{
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--text);
      cursor: pointer;
    }
    button:hover{ background: var(--btn-bg-hover); }
    button:disabled{ opacity: 0.45; cursor: not-allowed; }

    table{ border-collapse: collapse; width: 100%; }
    td{ padding: 6px 8px; border-bottom: 1px solid var(--border); }
    td:first-child{ width: 110px; font-weight: 700; }
    .danger{ color: var(--danger); }

    /* Attribute rows (normal): [-] [+] | NAME | VALUE | (MOD) */
    .attr{
      display: grid;
      grid-template-columns: 38px 38px 1fr;
      column-gap: 10px;
      align-items: center;
      padding: 6px 0;
      font-size: 24px;
    }
    .attr button{
      width: 38px;
      padding: 6px 0;
    }

    /* Attribute rows (advanced): [-10] [-] [+] [+10] | NAME | VALUE | (MOD) */
    body.advanced .attr{
      grid-template-columns: 46px 38px 38px 46px 1fr;
    }
    body.advanced .attr .step10{
      width: 46px;
      font-size: 13px;
      padding: 7px 0;
    }

    .attr-line{
      display: grid;
      grid-template-columns: 70px 48px 60px;
      column-gap: 12px;
      align-items: baseline;
    }
    .attr-abbr{
      font-weight: 800;
      letter-spacing: 0.5px;
    }
    .attr-value{
      font-weight: 700;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .attr-mod{
      color: var(--muted);
      font-weight: 700;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    /* Advanced panel */
    .advanced-panel{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }
    .size-group{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .size-btn[aria-pressed="true"]{
      border-color: var(--accent);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 25%, transparent);
      font-weight: 800;
    }
  </style>
</head>

<body>
  <h1>Character Builder</h1>

  <div class="row card" style="justify-content: space-between;">
    <div class="row">
      <label>
        Level:
        <input id="levelInput" type="number" min="1" step="1" style="width: 90px;" />
      </label>
      <span class="pill">Total AP: <strong id="apTotal"></strong></span>
      <span class="pill">Spent AP: <strong id="apSpent"></strong></span>
      <span class="pill">Remaining AP: <strong id="apRemaining"></strong></span>
    </div>

    <div class="row">
      <button id="advancedBtn">Advanced Mode: Off</button>
      <button id="resetBtn">Reset</button>
      <button id="saveBtn">Save</button>
      <button id="loadBtn">Load</button>
      <button id="clearBtn">Clear Save</button>
    </div>
  </div>

  <div id="advancedPanel" class="card advanced-panel" style="display:none;">
    <div class="row" style="justify-content: space-between;">
      <div class="row">
        <span class="pill">Creature Size: <strong id="sizeLabel"></strong></span>
        <span class="pill">WL Modifier: <strong id="sizeWlModLabel"></strong></span>
      </div>
      <div class="size-group" aria-label="Creature Size">
        <button class="size-btn" data-size="Tiny">Tiny</button>
        <button class="size-btn" data-size="Small">Small</button>
        <button class="size-btn" data-size="Medium">Medium</button>
        <button class="size-btn" data-size="Large">Large</button>
        <button class="size-btn" data-size="Huge">Huge</button>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top: 12px;">
    <div class="card">
      <h2>Attributes</h2>
      <div id="attrList"></div>
    </div>

    <div class="card">
      <h2>Values</h2>
      <table>
        <tbody id="derivedTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const HARD_CAP = 40;
    const ATTRS = ["CON", "STR", "DEX", "INT", "WIL", "PER"];

    // Format: [threshold, { derivedStat: delta, ... }]
    const PERK_TABLES = {
      CON: [
        [1,  { wt: 2 }],[3,  { wt: 2 }],[5,  { wt: 1 }],[7,  { wt: 1 }],[9,  { wt: 1 }],
        [10, { tn: 1 }],[11, { wt: 1 }],[13, { wt: 1 }],[15, { wt: 1 }],[17, { wt: 1 }],[19, { wt: 1 }],
        [20, { tn: 1 }],[20, { wt: 1 }],
        [21, { wt: 2 }],[23, { wt: 2 }],[25, { wt: 2 }],[27, { wt: 2 }],[29, { wt: 2 }],
        [30, { tn: 1 }],
        [31, { wt: 2 }],[33, { wt: 2 }],[35, { wt: 2 }],[37, { wt: 2 }],[39, { wt: 2 }],
        [40, { tn: 2 }],[40, { wt: 6 }],
      ],
      STR: [
        [1,  { en: 5 }],[3,  { en: 5 }],[5,  { en: 5 }],[7,  { sp: 5 }],[9,  { en: 5 }],[11, { sp: 5 }],
        [13, { en: 5 }],[15, { sp: 5 }],[17, { en: 5 }],[19, { sp: 5 }],
        [21, { en: 10 }],[23, { sp: 5 }],[25, { en: 10 }],[27, { sp: 5 }],[29, { en: 10 }],[31, { sp: 5 }],
        [33, { en: 10 }],[35, { sp: 5 }],[37, { en: 10 }],[39, { sp: 5 }],[40, { en: 20 }],
      ],
      DEX: [
        [1,  { ms: 2 }],[3,  { ms: 2 }],[5,  { sp: 5 }],[7,  { ms: 2 }],[9,  { sp: 5 }],[11, { ms: 2 }],
        [13, { sp: 5 }],[15, { ms: 2 }],[17, { sp: 5 }],[19, { ms: 2 }],[21, { sp: 5 }],
        [23, { ms: 4 }],[25, { sp: 5 }],[27, { ms: 4 }],[29, { sp: 5 }],[31, { ms: 4 }],[33, { sp: 5 }],
        [35, { ms: 4 }],[37, { sp: 5 }],[39, { ms: 4 }],[40, { ms: 8 }],
      ],
      INT: [
        [1,  { mp: 5 }],[3,  { sp: 5 }],[5,  { mp: 5 }],[7,  { mp: 5 }],[9,  { sp: 5 }],[11, { mp: 5 }],
        [13, { sp: 5 }],[15, { mp: 5 }],[17, { sp: 5 }],[19, { mp: 5 }],[21, { sp: 5 }],
        [23, { mp: 10 }],[25, { sp: 5 }],[27, { mp: 10 }],[29, { sp: 5 }],[31, { mp: 10 }],[33, { sp: 5 }],
        [35, { mp: 10 }],[37, { sp: 5 }],[39, { mp: 10 }],[40, { mp: 20 }],
      ],
      WIL: [
        [1,  { mpr: 1 }],[3,  { wl: 1 }],[5,  { mpr: 1 }],[7,  { wl: 1 }],[9,  { mpr: 1 }],[11, { mpr: 1 }],
        [13, { wl: 1 }],[15, { mpr: 1 }],[17, { mpr: 1 }],[19, { wl: 1 }],
        [21, { mpr: 2 }],[23, { mpr: 2 }],[25, { wl: 1 }],[27, { mpr: 2 }],[29, { mpr: 2 }],[31, { wl: 1 }],
        [33, { mpr: 2 }],[35, { mpr: 2 }],[37, { wl: 1 }],[39, { mpr: 2 }],
      ],
      PER: [
        [1,  { sp: 5 }],[3,  { sp: 5 }],[5,  { sp: 5 }],[7,  { sp: 5 }],[9,  { sp: 5 }],[11, { sp: 5 }],
        [13, { sp: 5 }],[15, { sp: 5 }],[17, { sp: 5 }],[19, { sp: 5 }],
        [21, { sp: 10 }],[23, { sp: 10 }],[25, { sp: 10 }],[27, { sp: 10 }],[29, { sp: 10 }],[31, { sp: 10 }],
        [33, { sp: 10 }],[35, { sp: 10 }],[37, { sp: 10 }],[39, { sp: 10 }],
      ],
    };

    const BASE_DERIVED = {
      wt: 1,   // wound threshold
      wl: 3,   // wound limit
      tn: 3,   // toughness
      en: 0,   // energy
      mp: 0,   // mana points
      mpr: 0,  // mana regen
      ms: 0,   // movement speed
      // sp handled separately (base = level * 5)
    };

    const SIZE_WL_MOD = {
      Tiny: -2,
      Small: -1,
      Medium: 0,
      Large: 2,
      Huge: 4,
    };

    // ====== STATE ======
    const defaultState = () => ({
      level: 1,
      attrs: Object.fromEntries(ATTRS.map(a => [a, 0])),
      advanced: false,
      size: "Medium",
    });

    let state = defaultState();

    // ====== COST MATH ======
    // Total cost to reach v from 0 is 1+2+...+v = v*(v+1)/2
    function costToReach(v) { return (v * (v + 1)) / 2; }
    function totalAP() { return state.level * 10; }
    function spentAP() { return ATTRS.reduce((sum, a) => sum + costToReach(state.attrs[a]), 0); }
    function remainingAP() { return totalAP() - spentAP(); }

    // Cost to increase by k from current: (current+1)+...+(current+k)
    function costIncreaseBy(current, k) {
      let c = 0;
      for (let i = 1; i <= k; i++) c += (current + i);
      return c;
    }

    function maxIncreaseSteps(attr, requested) {
      const current = state.attrs[attr];
      return Math.max(0, Math.min(requested, HARD_CAP - current));
    }

    function maxDecreaseSteps(attr, requested) {
      const current = state.attrs[attr];
      return Math.max(0, Math.min(requested, current));
    }

    function canIncreaseBy(attr, step) {
      const current = state.attrs[attr];
      const k = maxIncreaseSteps(attr, step);
      if (k <= 0) return false;
      const cost = costIncreaseBy(current, k);
      return remainingAP() >= cost;
    }

    function canDecreaseBy(attr, step) {
      const k = maxDecreaseSteps(attr, step);
      return k > 0;
    }

    function adjustAttr(attr, delta) {
      const current = state.attrs[attr];
      if (delta === 0) return;

      if (delta > 0) {
        const k = maxIncreaseSteps(attr, delta);
        if (k <= 0) return;
        const cost = costIncreaseBy(current, k);
        if (remainingAP() < cost) return;
        state.attrs[attr] = current + k;
        return;
      }

      // delta < 0
      const k = maxDecreaseSteps(attr, -delta);
      if (k <= 0) return;
      state.attrs[attr] = current - k;
    }

    // ====== MODS & DERIVED ======
    function attrMod(value) {
      return Math.floor(value / 2);
    }

    function computeDerived() {
      const d = { ...BASE_DERIVED, sp: state.level * 5 };

      for (const attr of ATTRS) {
        const v = state.attrs[attr];
        const perks = PERK_TABLES[attr] || [];
        for (const [threshold, delta] of perks) {
          if (v >= threshold) {
            for (const [k, add] of Object.entries(delta)) {
              d[k] = (d[k] ?? 0) + add;
            }
          }
        }
      }

      // Size affects WL
      const wlMod = SIZE_WL_MOD[state.size] ?? 0;
      d.wl += wlMod;

      // Colossus rules (apply AFTER size)
      const con = state.attrs.CON;
      if (con >= 40) {
        // WT quartered, WL quadrupled
        d.wt = Math.floor(d.wt / 4);
        d.wl = d.wl * 4;
      } else if (con >= 20) {
        // WT halved, WL doubled
        d.wt = Math.floor(d.wt / 2);
        d.wl = d.wl * 2;
      }

      return d;
    }

    // ====== RENDER ======
    const elLevel = document.getElementById("levelInput");
    const elApTotal = document.getElementById("apTotal");
    const elApSpent = document.getElementById("apSpent");
    const elApRem = document.getElementById("apRemaining");
    const elAttrList = document.getElementById("attrList");
    const elDerivedTable = document.getElementById("derivedTable");

    const elAdvancedBtn = document.getElementById("advancedBtn");
    const elAdvancedPanel = document.getElementById("advancedPanel");
    const elSizeLabel = document.getElementById("sizeLabel");
    const elSizeWlModLabel = document.getElementById("sizeWlModLabel");
    const sizeButtons = Array.from(document.querySelectorAll(".size-btn"));

    function renderAdvancedUI() {
      document.body.classList.toggle("advanced", !!state.advanced);
      elAdvancedPanel.style.display = state.advanced ? "" : "none";
      elAdvancedBtn.textContent = `Advanced Mode: ${state.advanced ? "On" : "Off"}`;

      elSizeLabel.textContent = state.size;
      const wlMod = SIZE_WL_MOD[state.size] ?? 0;
      elSizeWlModLabel.textContent = (wlMod >= 0 ? `+${wlMod}` : `${wlMod}`);

      for (const btn of sizeButtons) {
        const pressed = btn.dataset.size === state.size;
        btn.setAttribute("aria-pressed", pressed ? "true" : "false");
      }
    }

    function render() {
      elLevel.value = state.level;
      elApTotal.textContent = totalAP();
      elApSpent.textContent = spentAP();

      const rem = remainingAP();
      elApRem.textContent = rem;
      elApRem.className = rem < 0 ? "danger" : "";

      renderAdvancedUI();

      // Attributes UI
      elAttrList.innerHTML = "";
      for (const attr of ATTRS) {
        const v = state.attrs[attr];

        const wrap = document.createElement("div");
        wrap.className = "attr";

        // Advanced: -10 button
        if (state.advanced) {
          const minus10 = document.createElement("button");
          minus10.className = "step10";
          minus10.textContent = "–10";
          minus10.disabled = !canDecreaseBy(attr, 10);
          minus10.onclick = () => { adjustAttr(attr, -10); render(); };
          wrap.appendChild(minus10);
        }

        // -1 button
        const minus = document.createElement("button");
        minus.textContent = "–";
        minus.disabled = !canDecreaseBy(attr, 1);
        minus.onclick = () => { adjustAttr(attr, -1); render(); };
        wrap.appendChild(minus);

        // +1 button
        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.disabled = !canIncreaseBy(attr, 1);
        plus.onclick = () => { adjustAttr(attr, +1); render(); };
        wrap.appendChild(plus);

        // Advanced: +10 button
        if (state.advanced) {
          const plus10 = document.createElement("button");
          plus10.className = "step10";
          plus10.textContent = "+10";
          plus10.disabled = !canIncreaseBy(attr, 10);
          plus10.onclick = () => { adjustAttr(attr, +10); render(); };
          wrap.appendChild(plus10);
        }

        // Text line: CON  {value} ({mod})
        const line = document.createElement("div");
        line.className = "attr-line";
        line.innerHTML = `
          <span class="attr-abbr">${attr}</span>
          <span class="attr-value">${v}</span>
          <span class="attr-mod">(${attrMod(v)})</span>
        `;

        wrap.appendChild(line);
        elAttrList.appendChild(wrap);
      }

      // Derived UI
      const d = computeDerived();
      const rows = [
        ["EN", d.en],
        ["MP | MPR", `${d.mp} | ${d.mpr}`],
        ["WL", d.wl],
        ["WT", d.wt],
        ["TN", d.tn],
        ["MS", d.ms],
        ["SP", d.sp],
      ];

      elDerivedTable.innerHTML = rows.map(([k, val]) =>
        `<tr><td>${escapeHtml(k)}</td><td>${escapeHtml(val)}</td></tr>`
      ).join("");
    }

    // ====== PERSISTENCE ======
    const STORAGE_KEY = "generia_helper_v3";
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    function load() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const parsed = JSON.parse(raw);
        const next = defaultState();

        next.level = clampInt(parsed.level, 1, 999);
        for (const a of ATTRS) next.attrs[a] = clampInt(parsed.attrs?.[a], 0, HARD_CAP);

        next.advanced = !!parsed.advanced;
        next.size = (parsed.size in SIZE_WL_MOD) ? parsed.size : "Medium";

        state = next;
        return true;
      } catch {
        return false;
      }
    }

    function clearSave(){ localStorage.removeItem(STORAGE_KEY); }

    // ====== UTIL ======
    function clampInt(x, min, max) {
      const n = Number.isFinite(+x) ? Math.trunc(+x) : min;
      return Math.max(min, Math.min(max, n));
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ====== EVENTS ======
    elLevel.addEventListener("input", () => {
      state.level = clampInt(elLevel.value, 1, 999);
      render();
    });

    elAdvancedBtn.onclick = () => {
      state.advanced = !state.advanced;
      render();
    };

    for (const btn of sizeButtons) {
      btn.onclick = () => {
        state.size = btn.dataset.size;
        render();
      };
    }

    document.getElementById("resetBtn").onclick = () => { state = defaultState(); render(); };
    document.getElementById("saveBtn").onclick = () => { save(); alert("Saved."); };
    document.getElementById("loadBtn").onclick = () => { if (load()) render(); else alert("No save found (or invalid)."); };
    document.getElementById("clearBtn").onclick = () => { clearSave(); alert("Cleared saved data."); };

    // Initial
    load();
    render();
  </script>
</body>
</html>